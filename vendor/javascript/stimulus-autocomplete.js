import{Controller as t}from"@hotwired/stimulus";const e="[role='option']:not([aria-disabled])";const s="[aria-selected='true']";class Autocomplete extends t{static targets=["input","hidden","results"];static classes=["selected"];static values={ready:Boolean,submitOnEnter:Boolean,url:String,minLength:Number,delay:{type:Number,default:300},queryParam:{type:String,default:"q"}};static uniqOptionId=0;connect(){this.close();this.inputTarget.hasAttribute("autocomplete")||this.inputTarget.setAttribute("autocomplete","off");this.inputTarget.setAttribute("spellcheck","false");this.mouseDown=false;this.onInputChange=debounce(this.onInputChange,this.delayValue);this.inputTarget.addEventListener("keydown",this.onKeydown);this.inputTarget.addEventListener("blur",this.onInputBlur);this.inputTarget.addEventListener("input",this.onInputChange);this.resultsTarget.addEventListener("mousedown",this.onResultsMouseDown);this.resultsTarget.addEventListener("click",this.onResultsClick);this.inputTarget.hasAttribute("autofocus")&&this.inputTarget.focus();this.readyValue=true}disconnect(){if(this.hasInputTarget){this.inputTarget.removeEventListener("keydown",this.onKeydown);this.inputTarget.removeEventListener("blur",this.onInputBlur);this.inputTarget.removeEventListener("input",this.onInputChange)}if(this.hasResultsTarget){this.resultsTarget.removeEventListener("mousedown",this.onResultsMouseDown);this.resultsTarget.removeEventListener("click",this.onResultsClick)}}sibling(t){const e=this.options;const s=this.selectedOption;const i=e.indexOf(s);const n=t?e[i+1]:e[i-1];const r=t?e[0]:e[e.length-1];return n||r}select(t){const e=this.selectedOption;if(e){e.removeAttribute("aria-selected");e.classList.remove(...this.selectedClassesOrDefault)}t.setAttribute("aria-selected","true");t.classList.add(...this.selectedClassesOrDefault);this.inputTarget.setAttribute("aria-activedescendant",t.id);t.scrollIntoView({behavior:"auto",block:"nearest"})}onKeydown=t=>{const e=this[`on${t.key}Keydown`];e&&e(t)};onEscapeKeydown=t=>{if(this.resultsShown){this.hideAndRemoveOptions();t.stopPropagation();t.preventDefault()}};onArrowDownKeydown=t=>{const e=this.sibling(true);e&&this.select(e);t.preventDefault()};onArrowUpKeydown=t=>{const e=this.sibling(false);e&&this.select(e);t.preventDefault()};onTabKeydown=t=>{const e=this.selectedOption;e&&this.commit(e)};onEnterKeydown=t=>{const e=this.selectedOption;if(e&&this.resultsShown){this.commit(e);this.hasSubmitOnEnterValue||t.preventDefault()}};onInputBlur=()=>{this.mouseDown||this.close()};commit(t){if("true"===t.getAttribute("aria-disabled"))return;if(t instanceof HTMLAnchorElement){t.click();this.close();return}const e=t.getAttribute("data-autocomplete-label")||t.textContent.trim();const s=t.getAttribute("data-autocomplete-value")||e;this.inputTarget.value=e;if(this.hasHiddenTarget){this.hiddenTarget.value=s;this.hiddenTarget.dispatchEvent(new Event("input"));this.hiddenTarget.dispatchEvent(new Event("change"))}else this.inputTarget.value=s;this.inputTarget.focus();this.hideAndRemoveOptions();this.element.dispatchEvent(new CustomEvent("autocomplete.change",{bubbles:true,detail:{value:s,textValue:e,selected:t}}))}clear(){this.inputTarget.value="";this.hasHiddenTarget&&(this.hiddenTarget.value="")}onResultsClick=t=>{if(!(t.target instanceof Element))return;const s=t.target.closest(e);s&&this.commit(s)};onResultsMouseDown=()=>{this.mouseDown=true;this.resultsTarget.addEventListener("mouseup",(()=>{this.mouseDown=false}),{once:true})};onInputChange=()=>{this.hasHiddenTarget&&(this.hiddenTarget.value="");const t=this.inputTarget.value.trim();t&&t.length>=this.minLengthValue?this.fetchResults(t):this.hideAndRemoveOptions()};identifyOptions(){const t=this.resultsTarget.id||"stimulus-autocomplete";const s=this.resultsTarget.querySelectorAll(`${e}:not([id])`);s.forEach((e=>e.id=`${t}-option-${Autocomplete.uniqOptionId++}`))}hideAndRemoveOptions(){this.close();this.resultsTarget.innerHTML=null}fetchResults=async t=>{if(!this.hasUrlValue)return;const e=this.buildURL(t);try{this.element.dispatchEvent(new CustomEvent("loadstart"));const t=await this.doFetch(e);this.replaceResults(t);this.element.dispatchEvent(new CustomEvent("load"));this.element.dispatchEvent(new CustomEvent("loadend"))}catch(t){this.element.dispatchEvent(new CustomEvent("error"));this.element.dispatchEvent(new CustomEvent("loadend"));throw t}};buildURL(t){const e=new URL(this.urlValue,window.location.href);const s=new URLSearchParams(e.search.slice(1));s.append(this.queryParamValue,t);e.search=s.toString();return e.toString()}doFetch=async t=>{const e=await fetch(t,this.optionsForFetch());if(!e.ok)throw new Error(`Server responded with status ${e.status}`);const s=await e.text();return s};replaceResults(t){this.resultsTarget.innerHTML=t;this.identifyOptions();this.options?this.open():this.close()}open(){if(!this.resultsShown){this.resultsShown=true;this.element.setAttribute("aria-expanded","true");this.element.dispatchEvent(new CustomEvent("toggle",{detail:{action:"open",inputTarget:this.inputTarget,resultsTarget:this.resultsTarget}}))}}close(){if(this.resultsShown){this.resultsShown=false;this.inputTarget.removeAttribute("aria-activedescendant");this.element.setAttribute("aria-expanded","false");this.element.dispatchEvent(new CustomEvent("toggle",{detail:{action:"close",inputTarget:this.inputTarget,resultsTarget:this.resultsTarget}}))}}get resultsShown(){return!this.resultsTarget.hidden}set resultsShown(t){this.resultsTarget.hidden=!t}get options(){return Array.from(this.resultsTarget.querySelectorAll(e))}get selectedOption(){return this.resultsTarget.querySelector(s)}get selectedClassesOrDefault(){return this.hasSelectedClass?this.selectedClasses:["active"]}optionsForFetch(){return{headers:{"X-Requested-With":"XMLHttpRequest"}}}}const debounce=(t,e=10)=>{let s=null;return(...i)=>{clearTimeout(s);s=setTimeout(t,e)}};export{Autocomplete,Autocomplete as default};

